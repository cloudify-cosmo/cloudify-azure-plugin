tosca_definitions_version: cloudify_dsl_1_2

imports:
- http://www.getcloudify.org/spec/cloudify/3.3.1/types.yaml
- https://raw.githubusercontent.com/01000101/cloudify-azure-plugin/rebuild/plugin.yaml
  

inputs:
  resource_prefix:
    default: josh
  resource_suffix:
    default: 11
  subscription_id:
    type: string
    required: true
  tenant_id:
    type: string
    required: true
  client_id:
    type: string
    required: true
  client_secret:
    type: string
    required: true
  location:
    type: string
    required: true
    default: eastus
  retry_after:
    type: integer
    default: 120
  # VM inputs
  vm_size: 
    type: string
    required: true
  vm_image_publisher: 
    type: string
    required: true
  vm_image_offer: 
    type: string
    required: true
  vm_image_sku:
    type: string
    required: true
  vm_image_version:
    type: string
    required: true
  vm_os_username: 
    type: string
    required: true
  vm_os_password: 
    type: string
    required: true
  # Auth inputs
  azure_config:
    default:
      subscription_id: { get_input: subscription_id }
      tenant_id: { get_input: tenant_id }
      client_id: { get_input: client_id }
      client_secret: { get_input: client_secret }


node_templates:
  resource_group:
    type: cloudify.azure.nodes.ResourceGroup
    properties:
      name: {concat:[{get_input: resource_prefix},rg,{get_input: resource_suffix}]}
      location: { get_input: location }
      azure_config: { get_input: azure_config }
      
  storage_account:
    type: cloudify.azure.nodes.storage.StorageAccount
    properties:
      name: {concat:[{get_input: resource_prefix},sa,{get_input: resource_suffix}]}
      location: { get_input: location }
      retry_after: { get_input: retry_after }
      azure_config: { get_input: azure_config }
      resource_config:
        accountType: Standard_LRS
    relationships:
    - type: cloudify.azure.relationships.contained_in_resource_group
      target: resource_group
      
  virtual_network:
    type: cloudify.azure.nodes.network.VirtualNetwork
    properties:
      resource_group_name: joshrg02
      name: joshvnet02
      use_external_resource: true
      location: eastus
      azure_config: { get_input: azure_config }
    relationships:
    - type: cloudify.azure.relationships.contained_in_resource_group
      target: resource_group
      
  subnet:
    type: cloudify.azure.nodes.network.Subnet
    properties:
      name: {concat:[{get_input: resource_prefix},subnet,{get_input: resource_suffix}]}
      location: { get_input: location }
      retry_after: { get_input: retry_after }
      azure_config: { get_input: azure_config }
      resource_config:
        addressPrefix: 10.1.1.0/24
    relationships:
    - type: cloudify.azure.relationships.contained_in_virtual_network
      target: virtual_network
      
  route_table:
    type: cloudify.azure.nodes.network.RouteTable
    properties:
      name: {concat:[{get_input: resource_prefix},rt,{get_input: resource_suffix}]}
      location: { get_input: location }
      retry_after: { get_input: retry_after }
      azure_config: { get_input: azure_config }
    relationships:
    - type: cloudify.azure.relationships.contained_in_resource_group
      target: resource_group
    - type: cloudify.azure.relationships.route_table_attached_to_subnet
      target: subnet
      
  route_internet:
    type: cloudify.azure.nodes.network.Route
    properties:
      name: {concat:[{get_input: resource_prefix},route,{get_input: resource_suffix}]}
      location: { get_input: location }
      retry_after: { get_input: retry_after }
      azure_config: { get_input: azure_config }
      resource_config:
        addressPrefix: 0.0.0.0/0
        nextHopType: Internet
    relationships:
    - type: cloudify.azure.relationships.contained_in_route_table
      target: route_table

  route_cfy_manager:
    type: cloudify.azure.nodes.network.Route
    properties:
      name: {concat:[{get_input: resource_prefix},route,{get_input: resource_suffix}]}
      location: { get_input: location }
      retry_after: { get_input: retry_after }
      azure_config: { get_input: azure_config }
      resource_config:
        addressPrefix: 10.1.0.0/16
        nextHopType: VnetLocal
    relationships:
    - type: cloudify.azure.relationships.contained_in_route_table
      target: route_table
    - type: cloudify.relationships.depends_on
      target: route_internet

  network_security_group:
    type: cloudify.azure.nodes.network.NetworkSecurityGroup
    properties:
      name: {concat:[{get_input: resource_prefix},nsg,{get_input: resource_suffix}]}
      location: { get_input: location }
      retry_after: { get_input: retry_after }
      azure_config: { get_input: azure_config }
    relationships:
    - type: cloudify.azure.relationships.contained_in_resource_group
      target: resource_group
    - type: cloudify.azure.relationships.network_security_group_attached_to_subnet
      target: subnet
      
  network_security_rule_rdp:
    type: cloudify.azure.nodes.network.NetworkSecurityRule
    properties:
      name: {concat:[{get_input: resource_prefix},nsr_rdp,{get_input: resource_suffix}]}
      location: { get_input: location }
      retry_after: { get_input: retry_after }
      azure_config: { get_input: azure_config }
      resource_config:
        description: RDP allow
        protocol: Tcp
        sourcePortRange: '*'
        destinationPortRange: 3389
        sourceAddressPrefix: '*'
        destinationAddressPrefix: '*'
        priority: 100
        access: Allow
        direction: Inbound
    relationships:
    - type: cloudify.azure.relationships.contained_in_network_security_group
      target: network_security_group
  
  network_security_rule_winrm:
    type: cloudify.azure.nodes.network.NetworkSecurityRule
    properties:
      name: {concat:[{get_input: resource_prefix},nsr_winrm,{get_input: resource_suffix}]}
      location: { get_input: location }
      retry_after: { get_input: retry_after }
      azure_config: { get_input: azure_config }
      resource_config:
        description: WinRM-HTTP allow
        protocol: Tcp
        sourcePortRange: '*'
        destinationPortRange: 5985
        sourceAddressPrefix: '*'
        destinationAddressPrefix: '*'
        priority: 101
        access: Allow
        direction: Inbound
    relationships:
    - type: cloudify.azure.relationships.contained_in_network_security_group
      target: network_security_group
    - type: cloudify.relationships.depends_on
      target: network_security_rule_rdp
  
  public_ip_address:
    type: cloudify.azure.nodes.network.PublicIPAddress
    properties:
      name: {concat:[{get_input: resource_prefix},pip,{get_input: resource_suffix}]}
      location: { get_input: location }
      retry_after: { get_input: retry_after }
      azure_config: { get_input: azure_config }
      resource_config:
        publicIPAllocationMethod: Static
    relationships:
    - type: cloudify.azure.relationships.contained_in_resource_group
      target: resource_group
   
  ip_configuration:
    type: cloudify.azure.nodes.network.IPConfiguration
    properties:
      name: {concat:[{get_input: resource_prefix},ip,{get_input: resource_suffix}]}
      resource_config:
        privateIPAllocationMethod: Dynamic
    relationships:
    - type: cloudify.azure.relationships.ip_configuration_connected_to_subnet
      target: subnet
    - type: cloudify.azure.relationships.ip_configuration_connected_to_public_ip
      target: public_ip_address
   
  network_interface_card:
    type: cloudify.azure.nodes.network.NetworkInterfaceCard
    properties:
      name: {concat:[{get_input: resource_prefix},nic,{get_input: resource_suffix}]}
      location: { get_input: location }
      retry_after: { get_input: retry_after }
      azure_config: { get_input: azure_config }
    relationships:
    - type: cloudify.azure.relationships.contained_in_resource_group
      target: resource_group
    - type: cloudify.azure.relationships.nic_connected_to_network_security_group
      target: network_security_group
    - type: cloudify.azure.relationships.nic_connected_to_ip_configuration
      target: ip_configuration
      
  availability_set:
    type: cloudify.azure.nodes.compute.AvailabilitySet
    properties:
      name: {concat:[{get_input: resource_prefix},availset,{get_input: resource_suffix}]}
      location: { get_input: location }
      retry_after: { get_input: retry_after }
      azure_config: { get_input: azure_config }
    relationships:
    - type: cloudify.azure.relationships.contained_in_resource_group
      target: resource_group

  virtual_machine:
    type: cloudify.azure.nodes.compute.VirtualMachine
    properties:
      name: {concat:[{get_input: resource_prefix},vm,{get_input: resource_suffix}]}
      location: { get_input: location }
      retry_after: { get_input: retry_after }
      azure_config: { get_input: azure_config }
      resource_config:
        hardwareProfile:
          vmSize: { get_input: vm_size }
        storageProfile:
          imageReference:
            publisher: { get_input: vm_image_publisher }
            offer: { get_input: vm_image_offer }
            sku: { get_input: vm_image_sku }
            version: { get_input: vm_image_version }
        osProfile:
          computerName: { get_property: [SELF, name] }
          adminUsername: { get_input: vm_os_username }
          adminPassword: { get_input: vm_os_password }
      agent_config:
        user: { get_input: vm_os_username }
        password: { get_input: vm_os_password }
    relationships:
    - type: cloudify.azure.relationships.contained_in_resource_group
      target: resource_group
    - type: cloudify.azure.relationships.connected_to_storage_account
      target: storage_account
    - type: cloudify.azure.relationships.connected_to_availability_set
      target: availability_set
    - type: cloudify.azure.relationships.vm_connected_to_network_interface_card
      target: network_interface_card
