##################################################################################
# Cloudify Azure built in types and plugins definitions.
##################################################################################

plugins:
  microsoft:
    executor: central_deployment_agent
    source: https://github.com/cloudify-cosmo/cloudify-azure-plugin/archive/master.zip

node_types:
  cloudify.azure.nodes.ResourceGroup:
    derived_from: cloudify.nodes.Root
    properties:
      azure_config:
        default: {}
      use_external_resource:
        description: >
          Indicates whether to use external resource or not. Default value is false
        type: boolean
        default: false
      existing_resource_group_name:
        description: >
         Indicates the name of existing resource group
        type: string
        default: ''
      
    interfaces:
      cloudify.interfaces.lifecycle:
        configure: microsoft.azurecloudify.resourcegroup.create_resource_group
        start:
          implementation: microsoft.azurecloudify.resourcegroup.verify_provision
          inputs:
            start_retry_interval:
              description: Polling interval in seconds until the resource group is provisioned
              type: integer
              default: 30
        delete: microsoft.azurecloudify.resourcegroup.delete_resource_group
      cloudify.interfaces.validation:
        creation: microsoft.azurecloudify.resourcegroup.creation_validation
        
  cloudify.azure.nodes.SecurityGroup:
    derived_from: cloudify.nodes.SecurityGroup
    properties:
      use_external_resource:
        description: >
          Indicates whether to use external resource or not. Default value is false
        type: boolean
        default: false
      existing_security_group_name:
        description: >
         Indicates the name of exsisting network security group
        type: string
        default: ''
      security_group_protocol:
        description: >
          Indicates the name of the protocol required to create network security group
        type: string
        default: '*'
      security_group_access:
        description: >
          Indicates the access required to create network security group
        type: string
        default: 'Allow'
      security_group_priority:
        description: >
          Indicates the priority required to create network security group
        type: string
        default: '100'
      security_group_direction:
        description: >
          Indicates the direction required to create network security group
        type: string
        default: 'Inbound' 
      security_group_sourcePortRange:
        description: >
          Indicates the source port range required to create network security group
        type: string
        default: '*'
      security_group_destinationPortRange:
        description: >
          Indicates the destination port rangerequired to create network security group
        type: string
        default: '*'
      security_group_sourceAddressPrefix:
        description: >
          Indicates the source address prefix required to create network security group
        type: string
        default: '*'
      security_group_destinationAddressPrefix:
        description: >
          Indicates the destination address prefix required to create network security group
        type: string
        default: '*'
      rules:
       default: []

    interfaces:
      cloudify.interfaces.lifecycle:
        configure: microsoft.azurecloudify.securitygroup.create_security_group
        start:          
          implementation: microsoft.azurecloudify.securitygroup.verify_provision
          inputs:
            start_retry_interval:
              description: Polling interval in seconds until the securitygroup is provisioned
              type: integer
              default: 30
        delete: microsoft.azurecloudify.securitygroup.delete_security_group
      cloudify.interfaces.validation:
        creation: microsoft.azurecloudify.securitygroup.creation_validation
              
  cloudify.azure.nodes.Server:
    derived_from: cloudify.nodes.Compute
    properties:
      azure_config:
        default: {}
      vm_prefix:
        description: >
          Indicates the prefix of the VM's name
      vm_size:
        description: >
          Indicates the size of VM
        type: string
        default: 'Standard A0'
      image_reference_offer:
        description: >
          Flavour of virtual machine
        type: string
        default: 'UbuntuServer'
      image_reference_publisher:
        description: >
          Publisher of virtual machine
        type: string
        default: 'Canonical'
      image_reference_sku:
        description: >
          Version of operating system
        type: string
        default: 'UbuntuServer'        
      key_data:
        description: >
           Indicates the ssh public-key data of the user
        type: string
        default: ''
      ssh_username:
        description: >
          Indicates the name of the virtual machine required to create network interface card
        type: string
        default: ''

    interfaces:
      cloudify.interfaces.lifecycle:
        configure:
          implementation: microsoft.azurecloudify.server.create_vm           
        start:          
          implementation: microsoft.azurecloudify.server.check_if_vm_started
          inputs:
            start_retry_interval:
              description: Polling interval in seconds until the server ips are ready
              type: integer
              default: 30
        stop:
          implementation: microsoft.azurecloudify.server.stop_vm
        delete:
          implementation: microsoft.azurecloudify.server.delete_virtual_machine
      cloudify.interfaces.validation:
        creation:
          implementation: microsoft.azurecloudify.server.creation_validation


  cloudify.azure.nodes.ServerWithNic:
    derived_from: cloudify.azure.nodes.Server
    properties:
      use_external_resource:
        description: >
         Indicates whether to use external resource or not. Default value is false
        type: boolean
        default: false
      existing_nic_name:
        description: >
         Indicates the name of existing network interface card
        type: string
        default: ''

    interfaces:
      cloudify.interfaces.lifecycle:
        configure:
          implementation: microsoft.azurecloudify.serverwithnic.create_vm_and_nic
        start:
          implementation: microsoft.azurecloudify.serverwithnic.start_vm          
          inputs:
            start_retry_interval:
              description: Polling interval in seconds until the serverwithnic is provisioned
              type: integer
              default: 30
        stop:
          implementation: microsoft.azurecloudify.serverwithnic.stop_vm
        delete:
          implementation: microsoft.azurecloudify.serverwithnic.delete_vm_and_nic
      cloudify.interfaces.validation:
        creation:
          implementation: microsoft.azurecloudify.serverwithnic.creation_validation


  cloudify.azure.nodes.PublicIP:
    derived_from: cloudify.nodes.VirtualIP
    properties:
      azure_config:
        default: {}
      use_external_resource:
        description: >
         Indicates whether to use external resource or not. Default value is false
        type: boolean
        default: false
      existing_public_ip_name:
        description: >
         Indicates the name of existing public ip
        type: string
        default: ''

    interfaces:
      cloudify.interfaces.lifecycle:
        configure: microsoft.azurecloudify.publicip.create_public_ip
        start:          
          implementation: microsoft.azurecloudify.publicip.verify_provision
          inputs:
            start_retry_interval:
              description: Polling interval in seconds until the publicip is provisioned
              type: integer
              default: 30
        delete: microsoft.azurecloudify.publicip.delete_public_ip
      cloudify.interfaces.validation:
        creation: microsoft.azurecloudify.publicip.creation_validation
        
  cloudify.azure.nodes.CustomScript:
    derived_from: cloudify.nodes.Root
    properties:
      azure_config:
        default: {}
      use_external_resource:
        description: >
         Indicates whether to use external resource or not. Default value is false
        type: boolean
        default: false
      custom_script_path:
        description: >
          Indicates the url/path of the file to be run as the custom script on the vm
        type: string
        default: ''
      custom_script_command:
        description: >
          Indicates the terminal command used to run the custom script
        type: string
        default: ''

    interfaces:
      cloudify.interfaces.lifecycle:
        configure: microsoft.azurecloudify.extensions.create_custom_script
        start:          
          implementation: microsoft.azurecloudify.extensions.verify_provision
          inputs:
            start_retry_interval:
              description: Polling interval in seconds until the extension is provisioned
              type: integer
              default: 30
      cloudify.interfaces.validation:
        creation: microsoft.azurecloudify.extensions.creation_validation
        
  cloudify.azure.nodes.DataDisk:
    derived_from: cloudify.nodes.Root
    properties:
      azure_config:
        default: {}
      use_external_resource:
        description: >
         Indicates whether to use external resource or not. Default value is false
        type: boolean
        default: false
      data_disk_size_GB:
        description: >
          Storage capacity of external disk (optional) in GBs
        type: string
        default: '0'
      lun:
        description: >
          number of disks
        type: integer
        default: 1

    interfaces:
      cloudify.interfaces.lifecycle:
        configure: microsoft.azurecloudify.datadisk.create_disk
      cloudify.interfaces.validation:
        creation: microsoft.azurecloudify.datadisk.creation_validation

  cloudify.azure.nodes.StorageAccount:
    derived_from: cloudify.nodes.Root
    properties:
      azure_config:
        default: {}
      use_external_resource:
        description: >
         Indicates whether to use external resource or not. Default value is false
        type: boolean
        default: false
      existing_storage_account_name:
        description: >
         Indicates the name of existing storage account
        type: string
        default: ''

    interfaces:
      cloudify.interfaces.lifecycle:
        configure: microsoft.azurecloudify.storageaccount.create_storage_account
        start:          
          implementation: microsoft.azurecloudify.storageaccount.verify_provision
          inputs:
            start_retry_interval:
              description: Polling interval in seconds until the storageaccount is provisioned
              type: integer
              default: 30
        delete: microsoft.azurecloudify.storageaccount.delete_storage_account
      cloudify.interfaces.validation:
        creation: microsoft.azurecloudify.storageaccount.creation_validation

  cloudify.azure.nodes.NIC:
    derived_from: cloudify.nodes.Port
    properties:
      azure_config:
        default: {}
      use_external_resource:
        description: >
         Indicates whether to use external resource or not. Default value is false
        type: boolean
        default: false
      existing_nic_name:
        description: >
         Indicates the name of existing network interface card
        type: string
        default: ''

    interfaces:
      cloudify.interfaces.lifecycle:
        configure: microsoft.azurecloudify.nic.create_nic
        start:          
          implementation: microsoft.azurecloudify.nic.verify_provision
          inputs:
            start_retry_interval:
              description: Polling interval in seconds until the nic is provisioned
              type: integer
              default: 30
        delete: microsoft.azurecloudify.nic.delete_nic
      cloudify.interfaces.validation:
        creation: microsoft.azurecloudify.nic.creation_validation

  cloudify.azure.nodes.VNET:
    derived_from: cloudify.nodes.Network
    properties:
      azure_config:
        default: {}
      use_external_resource:
        description: >
         Indicates whether to use external resource or not. Default value is false
        type: boolean
        default: false
      existing_vnet_name:
        description: >
         Indicates the name of exsisting virtual network
        type: string
        default: ''

    interfaces:
      cloudify.interfaces.lifecycle:
        configure: microsoft.azurecloudify.vnet.create_vnet
        start:          
          implementation: microsoft.azurecloudify.vnet.verify_provision
          inputs:
            start_retry_interval:
              description: Polling interval in seconds until the vnet is provisioned
              type: integer
              default: 30
        delete: microsoft.azurecloudify.vnet.delete_vnet
      cloudify.interfaces.validation:
        creation: microsoft.azurecloudify.vnet.creation_validation

  cloudify.azure.nodes.Subnet:
    derived_from: cloudify.nodes.Subnet
    properties:
      azure_config:
        default: {}
      use_external_resource:
        description: >
         Indicates whether to use external resource or not. Default value is false
        type: boolean
        default: false
      subnet:
        description: >
         Indicates the name of exsisting virtual subnet
        type: string
        default: ''

    interfaces:
      cloudify.interfaces.lifecycle:
        configure: microsoft.azurecloudify.subnet.create_subnet
        delete: microsoft.azurecloudify.subnet.delete_subnet
      cloudify.interfaces.validation:
        creation: microsoft.azurecloudify.subnet.creation_validation

  cloudify.azure.nodes.azure_token:
    derived_from: cloudify.nodes.Root
    properties:
      subscription_id:
        description: >
          Indicates the subscription id required to create virtual network.
        type: string
        default: ''
      location:
        description: >
         location where VM will be provisioned
        type: string
        default: 'West US'
      client_id:
        description: >
          Indicates the user's client id
        type: string
        default: ''
      tenant_id:
        description: >
          Indicates the user's tenant id
        type: string
        default: ''
      aad_password:
        description: >
          Indicates the name of the virtual machine required to create network interface card
        type: string
        default: ''
      application_id:
        description: >
          Indicates the name of Azure application id
        type: string
        default: ''
      username:
        description: >
          Indicates the Azure account username
        type: string
        default: ''
      password:
        description: >
          Indicates the Azure account password
        type: string
        default: ''
      grant_type:
        description: >
          Indicates the grant_type: 'client_credentials' (with aad_password) or 'password' (with aaplication_id)
        type: string
        default: 'client_credentials'

    interfaces:
      cloudify.interfaces.lifecycle:
        create:
          implementation: microsoft.azurecloudify.auth.initialize
          inputs:
            use_client_file:
              default: True
            start_retry_interval:
              description: Polling interval in seconds until the server is started
              type: integer
              default: 30

relationships:

   cloudify.azure.relationships.storage_account_contained_in_resource_group:
    derived_from: cloudify.relationships.contained_in
    source_interfaces:
      cloudify.interfaces.relationship_lifecycle:
        preconfigure:
          implementation: microsoft.azurecloudify.storageaccount.set_dependent_resources_names
          inputs:
            azure_config:
              default: {}

   cloudify.azure.relationships.subnet_contained_in_resource_group:
    derived_from: cloudify.relationships.contained_in
    source_interfaces:
      cloudify.interfaces.relationship_lifecycle:
        preconfigure:
          implementation: microsoft.azurecloudify.subnet.set_resource_group_details
          inputs:
            azure_config:
              default: {}
   
   cloudify.azure.relationships.vnet_contained_in_resource_group:
    derived_from: cloudify.relationships.contained_in
    source_interfaces:
      cloudify.interfaces.relationship_lifecycle:
        preconfigure:
          implementation: microsoft.azurecloudify.vnet.set_resource_group_details
          inputs:
            azure_config:
              default: {}

   cloudify.azure.relationships.server_connected_to_storage_account:
    derived_from: cloudify.relationships.connected_to
    source_interfaces:
      cloudify.interfaces.relationship_lifecycle:
        preconfigure:
          implementation: microsoft.azurecloudify.server.set_storage_account_details
          inputs:
            azure_config:
              default: {}
        postconfigure:
          implementation: microsoft.azurecloudify.server.start_vm
          inputs:
            start_retry_interval:
              description: Polling interval in seconds until the server is started
              type: integer
              default: 30

   cloudify.azure.relationships.security_group_contained_in_resource_group:
    derived_from: cloudify.relationships.contained_in
    source_interfaces:
      cloudify.interfaces.relationship_lifecycle:
        preconfigure:
          implementation: microsoft.azurecloudify.securitygroup.set_dependent_resources_names
          inputs:
            azure_config:
              default: {}


   cloudify.azure.relationships.subnet_connected_to_security_group:
    derived_from: cloudify.relationships.connected_to
    source_interfaces:
      cloudify.interfaces.relationship_lifecycle:
        preconfigure:
          implementation: microsoft.azurecloudify.subnet.set_security_group_details
          inputs:
            azure_config:
              default: {}

   cloudify.azure.relationships.nic_connected_to_security_group:
    derived_from: cloudify.relationships.connected_to
    source_interfaces:
      cloudify.interfaces.relationship_lifecycle:
        preconfigure:
          implementation: microsoft.azurecloudify.nic.set_security_group_details
          inputs:
            azure_config:
              default: {}

   cloudify.azure.relationships.vnet_connected_to_subnet:
    derived_from: cloudify.relationships.connected_to
    source_interfaces:
      cloudify.interfaces.relationship_lifecycle:
        preconfigure:
          implementation: microsoft.azurecloudify.vnet.set_subnet_details
          inputs:
            azure_config:
              default: {}
              

   cloudify.azure.relationships.public_ip_connected_to_vnet:
    derived_from: cloudify.relationships.connected_to
    source_interfaces:
      cloudify.interfaces.relationship_lifecycle:
        preconfigure:
          implementation: microsoft.azurecloudify.publicip.set_dependent_resources_names
          inputs:
            azure_config:
              default: {}


   cloudify.azure.relationships.nic_connected_to_public_ip:
    derived_from: cloudify.relationships.connected_to
    source_interfaces:
      cloudify.interfaces.relationship_lifecycle:
        preconfigure:
          implementation: microsoft.azurecloudify.nic.set_public_ip_details
          inputs:
            azure_config:
              default: {}

   cloudify.azure.relationships.nic_connected_to_vnet:
    derived_from: cloudify.relationships.connected_to
    source_interfaces:
      cloudify.interfaces.relationship_lifecycle:
        preconfigure:
          implementation: microsoft.azurecloudify.nic.set_vnet_details
          inputs:
            azure_config:
              default: {}

   cloudify.azure.relationships.server_connected_to_nic:
    derived_from: cloudify.relationships.connected_to
    source_interfaces:
      cloudify.interfaces.relationship_lifecycle:
        preconfigure:
          implementation: microsoft.azurecloudify.server.set_nic_details
          inputs:
            azure_config:
              default: {}

   cloudify.azure.relationships.custom_script_contained_in_server:
    derived_from: cloudify.relationships.contained_in
    source_interfaces:
      cloudify.interfaces.relationship_lifecycle:
        preconfigure:
          implementation: microsoft.azurecloudify.extensions.set_dependent_resources_names
          inputs:
            azure_config:
              default: {}
              
   cloudify.azure.relationships.server_connected_to_datadisk:
    derived_from: cloudify.relationships.connected_to
    source_interfaces:
      cloudify.interfaces.relationship_lifecycle:
        preconfigure:
          implementation: microsoft.azurecloudify.server.set_data_disks
          inputs:
            azure_config:
              default: {}

   cloudify.azure.relationships.datadisk_contained_in_storage_account:
    derived_from: cloudify.relationships.contained_in
    source_interfaces:
      cloudify.interfaces.relationship_lifecycle:
        preconfigure:
          implementation: microsoft.azurecloudify.datadisk.set_storageaccount_details
          inputs:
            azure_config:
              default: {}


   cloudify.azure.relationships.resource_depends_on_azure_token:
    derived_from: cloudify.relationships.depends_on
    target_interfaces:
      cloudify.interfaces.relationship_lifecycle:
        preconfigure:
          implementation: microsoft.azurecloudify.auth.set_azure_config
          inputs:
            azure_config:
              default: {}

   cloudify.azure.relationships.resource_contained_in_resource_group:
    derived_from: cloudify.relationships.contained_in
