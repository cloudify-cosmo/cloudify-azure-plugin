tosca_definitions_version: cloudify_dsl_1_2

imports:
  - http://www.getcloudify.org/spec/cloudify/3.3rc1/types.yaml
  - https://raw.githubusercontent.com/cloudify-cosmo/cloudify-azure-plugin/master/plugin.yaml
  - http://www.getcloudify.org/spec/fabric-plugin/1.3m6/plugin.yaml
  - types/manager-types.yaml


inputs:

  #############################
  # Provider specific Inputs
  #############################
  
  subscription_id:
    type: string
    default: ''

  location:
    type: string
    default: 'West US'

  vm_prefix:
    type: string
    default: 'cfy'

  vm_size:
    type: string
    default: 'Standard_A2'

  image_reference_offer:
    type: string
    default: 'UbuntuServer'

  image_reference_publisher:
    type: string
    default: 'Canonical'

  use_external_resource:
    type: boolean
    default: false

  existing_resource_group_name:
    type: string
    default: ''
    
  existing_security_group_name:
    type: string
    default: ''

  existing_storage_account_name:
    type: string
    default: ''

  existing_vnet_name:
    type: string
    default: ''

  existing_public_ip_name:
    type: string
    default: ''

  existing_nic_name:
    type: string
    default: ''

  image_reference_sku:
    type: string
    default: '14.04.2-LTS'

  key_data:
    type: string
    default: ''

  agent_remote_key_path:
    type: string
    default: '/home/azuretest/.ssh/agent_kp.pem'

  agent_local_key_path:
    type: string
    default: '~/.ssh/id_rsa'
    
  ssh_key_filename:
    type: string
    default: '~/.ssh/id_rsa'

  client_id:
    type: string
    default: ''

  tenant_id:
    type: string
    default: ''

  aad_password:
    type: string
    default: ''

  subnet:
    type: string
    default: ''

  ssh_user:
    type: string
    default: 'azuretest'
    
  custom_script_path:
    type: string
    default: ''
    
  custom_script_command:
    type: string
    default: ''
    
  data_disk_size_GB:
    type: string
    default: '0'
    
  security_group_priority: 
    type: string
    default: '100'
    
  security_group_protocol: 
    type: string
    default: '*'
    
  security_group_access: 
    type: string
    default: 'Allow'
    
  security_group_direction: 
    type: string
    default: 'Inbound'
    
  security_group_sourcePortRange: 
    type: string
    default: '*'
    
  security_group_destinationPortRange: 
    type: string
    default: '*'
    
  security_group_sourceAddressPrefix: 
    type: string
    default: '*'
    
  security_group_destinationAddressPrefix: 
    type: string
    default: '*'

node_templates:

  simple_host:
    type: cloudify.azure.nodes.Server
    properties:
      image_reference_offer: { get_input: image_reference_offer}
      image_reference_publisher: { get_input: image_reference_publisher}
      image_reference_sku: { get_input: image_reference_sku}
      vm_prefix: { get_input: vm_prefix}      
      vm_size: { get_input: vm_size}
      key_data: { get_input: key_data}
      subscription_id: { get_input: subscription_id}
      location: { get_input: location }
      client_id: { get_input: client_id}
      tenant_id: { get_input: tenant_id}
      ssh_username: { get_input: ssh_user}
      aad_password: { get_input: aad_password}    
      install_agent: false
    relationships:
      - target: azure_token
        type: cloudify.azure.relationships.resource_depends_on_azure_token


  simple_resource_group:
    type: cloudify.azure.nodes.ResourceGroup
    properties:
      location: { get_input: location}
      subscription_id: { get_input: subscription_id}
      client_id: { get_input: client_id}
      tenant_id: { get_input: tenant_id}
      aad_password: { get_input: aad_password}
      use_external_resource: { get_input: use_external_resource}
      existing_resource_group_name: { get_input: existing_resource_group_name}

    relationships:
      - target: azure_token
        type: cloudify.azure.relationships.resource_depends_on_azure_token


  simple_storage_account:
    type: cloudify.azure.nodes.StorageAccount
    properties:
      location: { get_input: location}
      subscription_id: { get_input: subscription_id}
      client_id: { get_input: client_id}
      tenant_id: { get_input: tenant_id}
      aad_password: { get_input: aad_password}
      use_external_resource: { get_input: use_external_resource}
      existing_storage_account_name: { get_input: existing_storage_account_name}

    relationships:
      - target: azure_token
        type: cloudify.azure.relationships.resource_depends_on_azure_token
        
  simple_data_disk:
    type: cloudify.azure.nodes.DataDisk
    properties:
      location: { get_input: location}
      subscription_id: { get_input: subscription_id}
      client_id: { get_input: client_id}
      tenant_id: { get_input: tenant_id}
      aad_password: { get_input: aad_password}
      data_disk_size_GB: { get_input: data_disk_size_GB}

    relationships:
      - target: azure_token
        type: cloudify.azure.relationships.resource_depends_on_azure_token

  simple_public_ip:
    type: cloudify.azure.nodes.PublicIP
    properties:
      location: { get_input: location}
      subscription_id: { get_input: subscription_id}
      client_id: { get_input: client_id}
      tenant_id: { get_input: tenant_id}
      aad_password: { get_input: aad_password}
      use_external_resource: { get_input: use_external_resource}
      existing_public_ip_name: { get_input: existing_public_ip_name}

    relationships:
      - target: azure_token
        type: cloudify.azure.relationships.resource_depends_on_azure_token

  simple_custom_script:
    type: cloudify.azure.nodes.CustomScript
    properties:
      location: { get_input: location}
      subscription_id: { get_input: subscription_id}
      client_id: { get_input: client_id}
      tenant_id: { get_input: tenant_id}
      aad_password: { get_input: aad_password}
      use_external_resource: { get_input: use_external_resource}
      custom_script_path: { get_input: custom_script_path}
      custom_script_command: { get_input: custom_script_command}

    relationships:
      - target: azure_token
        type: cloudify.azure.relationships.resource_depends_on_azure_token

  simple_nic:
    type: cloudify.azure.nodes.NIC
    properties:
      location: { get_input: location}
      subscription_id: { get_input: subscription_id}
      client_id: { get_input: client_id}
      tenant_id: { get_input: tenant_id}
      aad_password: { get_input: aad_password}
      use_external_resource: { get_input: use_external_resource}
      existing_nic_name: { get_input: existing_nic_name}

    relationships:
      - target: azure_token
        type: cloudify.azure.relationships.resource_depends_on_azure_token

  simple_security_group:
    type: cloudify.azure.nodes.SecurityGroup
    properties:
      location: { get_input: location}
      subscription_id: { get_input: subscription_id}
      client_id: { get_input: client_id}
      tenant_id: { get_input: tenant_id}
      aad_password: { get_input: aad_password}
      use_external_resource: { get_input: use_external_resource}
      existing_security_group_name: { get_input: existing_security_group_name}
      security_group_protocol: { get_input: security_group_protocol}
      security_group_access: { get_input: security_group_access}
      security_group_priority: { get_input: security_group_priority}
      security_group_sourcePortRange: { get_input: security_group_sourcePortRange}
      security_group_destinationPortRange: { get_input: security_group_destinationPortRange}
      security_group_sourceAddressPrefix: { get_input: security_group_sourceAddressPrefix}
      security_group_destinationAddressPrefix: { get_input: security_group_destinationAddressPrefix}
      security_group_direction: { get_input: security_group_direction}
      rules:
        - protocol: TCP
          from_port: 80
          to_port: 80
          cidr_ip: 0.0.0.0/32
        - protocol: TCP
          from_port: 443
          to_port: 443
          cidr_ip: 0.0.0.0/32
        - protocol: TCP
          from_port: 22
          to_port: 22
          cidr_ip: 0.0.0.0/32
        - protocol: TCP
          from_port: 8101
          to_port: 8101
          cidr_ip: 0.0.0.0/32
        - protocol: TCP
          from_port: 5672
          to_port: 5672
          cidr_ip: 0.0.0.0/32
        - protocol: TCP
          from_port: 53229
          to_port: 53229
          cidr_ip: 0.0.0.0/32

    relationships:
      - target: azure_token
        type: cloudify.azure.relationships.resource_depends_on_azure_token

  simple_subnet:
    type: cloudify.azure.nodes.Subnet
    properties:
      location: { get_input: location}
      subscription_id: { get_input: subscription_id}
      client_id: { get_input: client_id}
      tenant_id: { get_input: tenant_id}
      aad_password: { get_input: aad_password}
      use_external_resource: { get_input: use_external_resource}
      subnet: { get_input: subnet}
      
    relationships:
      - target: azure_token
        type: cloudify.azure.relationships.resource_depends_on_azure_token

  simple_vnet:
    type: cloudify.azure.nodes.VNET
    properties:
      location: { get_input: location}
      subscription_id: { get_input: subscription_id}
      client_id: { get_input: client_id}
      tenant_id: { get_input: tenant_id}
      aad_password: { get_input: aad_password}
      use_external_resource: { get_input: use_external_resource}
      existing_vnet_name: { get_input: existing_vnet_name}

    relationships:
      - target: azure_token
        type: cloudify.azure.relationships.resource_depends_on_azure_token
      
  azure_token:
    type: cloudify.azure.nodes.azure_token
    properties:
      client_id: { get_input: client_id }
      tenant_id: { get_input: tenant_id }
      aad_password: { get_input: aad_password }

plugins:
  cli:
    install: false
    executor: central_deployment_agent
